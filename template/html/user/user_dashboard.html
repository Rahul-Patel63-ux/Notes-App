{% load static %}

<!DOCTYPE html>
<html>

<head>
    <title>Notes App | User Dashboard</title>
    <style>
        body {
            font-family: Arial;
            max-width: 500px;
            margin: 20px auto;
        }

        .box {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        button {
            padding: 8px;
            margin: 5px 0;
            width: 20%;
        }

        .btn-link {
            display: inline-block;
            padding: 8px 10px;
            background: #86cdf6;
            color: #333;
            text-decoration: none;
            border-radius: 2px;
            font-weight: 150;
            border: 1px solid #5bb6e6;
            transition: 0.2s ease-in-out;
        }

        .btn-link:hover {
            background: #5bb6e6;
            color: #fff;
        }


        .msg {
            padding: 8px;
            margin-top: 8px;
            border-radius: 5px;
        }

        .success {
            background: #daf5d7;
        }

        .error {
            background: #ffd6d6;
        }

        #dashboard {
            display: none;
        }
    </style>
</head>

<body>

    <h2>Notes App</h2>

    <!-- Protected Dashboard -->
    <div id="dashboard" class="box">

        <div id="api_msg"></div>

        <a href="{% url 'create_note' %}" class="btn-link" style="background:#86cdf6;color:rgb(49, 48, 48);">Create
            Note</a>

        <h4>Your Notes</h4>
        <ul id="notes_list"></ul>

    </div>
    <button onclick="logoutUser()" style="background:#ff5c5c;color:white;">Logout</button>

    <script src="{% static 'js/scripts.js' %}"></script>

    <script>
        async function loadDashboardData() {
            const token = localStorage.getItem("access");

            if (!token) {
                window.location.href = "/login/";
                return;
            }

            const res = await fetch("http://127.0.0.1:8000/u/notes/", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            // If token expired or invalid
            if (res.status === 401) {
                localStorage.removeItem("access");
                window.location.href = "/login/";
                return;
            }

            const data = await res.json();
            console.log("Dashboard data:", data);

            // Show dashboard only if data successfully loaded
            document.getElementById("dashboard").style.display = "block";

            const ul = document.getElementById("notes_list");
            ul.innerHTML = "";

            data.data.forEach(note => {

                ul.innerHTML += `
                    <li style="margin-bottom:8px;">
                        <span>${note.note}</span>
                        
                        <a href="/u/notes/update/${note.id}/" class="btn-link"
                            style="margin-left:10px; padding:3px 8px;"
                        >Edit</a>

                        <a class="btn-link"
                            onclick="deleteNote(${note.id})" 
                            style="margin-left:5px; padding:3px 8px; background:red; color:white;"
                        >Delete</a>
                    </li>
                `;
            });
        }

        loadDashboardData();

        async function deleteNote(id) {

            const confirmDelete = confirm("Are you sure you want to delete this note?");

            if (!confirmDelete) {
                return; 
            }

            const token = localStorage.getItem("access");

            const res = await fetch(`${BASE_URL}/u/notes/${id}/`, {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            if (!res.ok) {
                alert("Failed to delete note!");
                return;
            }

            alert("Note deleted successfully!");
        }


        // LOGPUT FUNCITON
        function logoutUser() {
            console.log("Logout clicked");
            localStorage.removeItem("access");
            localStorage.removeItem("role");

            window.location.href = "/login/";
        }
    </script>

</body>

</html>